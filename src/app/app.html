<main class="h-screen bg-background text-foreground font-sans overflow-hidden flex flex-col selection:bg-primary/20">

  <!-- Initial Full Screen Loader -->
  <div *ngIf="isAppLoading()"
    class="fixed inset-0 z-[100] bg-background flex flex-col items-center justify-center animate-out fade-out duration-700 delay-500">
    <div class="size-64">
      <ng-lottie [options]="lottieOptions" />
    </div>
  </div>

  <!-- Content -->
  <div
    class="flex-1 block md:flex md:flex-row overflow-y-auto md:overflow-hidden relative custom-scrollbar md:custom-scrollbar-none"
    (mousemove)="onDrag($event)" (mouseup)="stopDrag()" (mouseleave)="stopDrag()">

    <!-- Left Column: Input -->
    <section [style.width.%]="isMobile() ? null : splitPosition()"
      class="sticky top-0 h-[100dvh] md:h-full md:static z-0 flex flex-col p-8 space-y-8 border-r border-border bg-card/10 min-w-[300px] w-full md:w-auto">
      <header class="flex items-center gap-2">
        <div class="flex flex-col">
          <h1 class="text-4xl font-serif font-semibold text-primary tracking-tight leading-none">PromptForge</h1>
          <p class="text-xs text-muted-foreground font-medium tracking-wide border-l-2 border-primary/30 pl-2 mt-1">
            Elevate your prompts easily</p>
        </div>
      </header>

      <div class="flex-1 flex flex-col space-y-6">
        <div class="space-y-1">
          <label hlmLabel class="text-sm font-bold uppercase tracking-wider text-muted-foreground">The
            Foundation</label>
        </div>

        <div class="flex-1 relative group">
          <!-- Loading Overlay in Textarea -->
          <div *ngIf="loading()"
            class="absolute inset-0 z-20 flex items-center justify-center bg-background/50 backdrop-blur-sm rounded-2xl animate-in fade-in duration-500">
            <div class="size-48">
              <ng-lottie [options]="lottieOptions" />
            </div>
          </div>

          <div
            class="absolute -inset-0.5 bg-gradient-to-br from-primary/20 to-transparent rounded-2xl blur opacity-20 group-hover:opacity-40 transition duration-1000">
          </div>
          <textarea hlmInput
            class="relative h-full w-full resize-none p-6 text-base border-primary/5 focus-visible:border-primary/40 transition-all bg-background/80 backdrop-blur-md rounded-2xl shadow-inner scrollbar-none"
            placeholder="Paste your raw prompt here to begin the forging process. e.g., Write a compelling story about an AI that discovers poetry..."
            [ngModel]="userPrompt()" (ngModelChange)="userPrompt.set($event)"></textarea>
        </div>

        <div class="flex justify-center pt-2">
          <button hlmBtn size="lg"
            class="w-full md:w-64 gap-3 shadow-2xl hover:shadow-primary/30 transition-all active:scale-95 bg-primary text-primary-foreground font-bold rounded-xl h-14"
            [disabled]="loading() || !userPrompt().trim()" (click)="analyze()">
            <ng-icon hlm name="lucideSparkles" class="size-5" [class.animate-spin]="loading()" />
            <span>{{ loading() ? 'FORGING...' : 'ENHANCE PROMPT' }}</span>
          </button>
        </div>

        <!-- Mobile Scroll Indicator -->
        <div *ngIf="(analysis() || loading()) && isMobile()"
          class="md:hidden flex flex-col items-center mt-6 text-muted-foreground/60">
          <span class="text-[10px] uppercase tracking-widest font-medium mb-1">Scroll to see results</span>
          <ng-icon hlm name="lucideChevronDown" class="size-5" />
        </div>
      </div>
    </section>

    <!-- Resizer Handle -->
    <div
      class="w-4 cursor-col-resize z-[60] hidden md:flex items-center justify-center -ml-2 h-full select-none relative group"
      (mousedown)="startDrag()">

      <!-- Theme Toggle Button (Attached) -->
      <div class="absolute top-6 left-1/2 -translate-x-1/2 z-[70]" (mousedown)="$event.stopPropagation()">
        <button hlmBtn variant="default" size="icon"
          class="rounded-full bg-background border border-border/50 shadow-sm hover:bg-muted/50 transition-all hover:rotate-180 size-8 flex items-center justify-center"
          (click)="toggleTheme()">
          <ng-icon hlm *ngIf="theme() === 'light'" name="lucideSun" class="size-4 text-yellow-500" />
          <ng-icon hlm *ngIf="theme() === 'dark'" name="lucideMoon" class="size-4 text-primary" />
        </button>
      </div>

      <!-- Handle Visuals -->
      <div class="h-12 w-1 rounded-full bg-border/50 group-hover:bg-border transition-colors"></div>
    </div>

    <!-- Right Column: Reimagined Results -->
    <section
      class="relative z-20 mt-[40vh] md:mt-0 min-h-screen md:min-h-0 md:h-full w-full md:w-auto flex-1 overflow-visible md:overflow-y-auto p-8 bg-background/90 backdrop-blur-xl md:bg-background/50 rounded-t-[2.5rem] md:rounded-none border-t border-primary/20 md:border-t-0 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] md:shadow-none space-y-8 custom-scrollbar">
      <div *ngIf="error()"
        class="p-4 bg-destructive/10 border border-destructive/20 rounded-xl flex items-center gap-3 text-destructive animate-in zoom-in-95 duration-300">
        <ng-icon hlm name="lucideAlertCircle" class="size-5" />
        <p class="font-medium text-sm">{{ error() }}</p>
      </div>

      <!-- Empty State -->
      <div *ngIf="!analysis() && !loading()"
        class="h-full flex flex-col items-center justify-center text-center space-y-6 opacity-30">
        <div class="relative">
          <div class="absolute -inset-4 bg-primary/20 blur-2xl rounded-full"></div>
          <ng-icon hlm name="lucideSparkles" class="size-24 text-primary relative" />
        </div>
        <div class="space-y-1">
          <p class="text-2xl font-serif font-medium">The Forge is Silent</p>
          <p class="text-sm font-sans tracking-wide">Enter a prompt on the left to start the analysis.</p>
        </div>
      </div>

      <!-- Analysis Dashboard -->
      <div *ngIf="analysis() || loading()" class="space-y-10 animate-in fade-in slide-in-from-right-10 duration-700">

        <!-- Header -->
        <div class="flex items-end justify-between border-b border-border pb-4">
          <h2 class="text-2xl font-serif font-bold tracking-tight">Forging Report</h2>
          <div class="flex items-center gap-2">
            <span hlmBadge variant="outline" class="text-[10px] py-0.5 px-2 bg-muted/30">usign Gemini 2.0 Stable</span>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-8">

          <!-- Tooling Matrix -->
          <div class="space-y-4">
            <div class="flex items-center gap-2 px-1">
              <h3 class="text-sm font-bold uppercase tracking-[0.2em] text-muted-foreground"># Tooling Matrix</h3>
            </div>

            <div class="flex flex-wrap gap-4">
              <ng-container *ngFor="let tool of analysis()?.suggestedTools">
                <ng-template #tooltipContent>
                  <!-- Notification Card Style Wrapper -->
                  <div
                    class="w-[340px] bg-popover border border-border rounded-xl shadow-2xl overflow-hidden flex flex-col animate-in fade-in-0 zoom-in-95 duration-200">

                    <!-- Header -->
                    <div class="flex items-center justify-between px-4 py-3 border-b border-border bg-muted/20">
                      <h3 class="font-semibold text-sm text-popover-foreground tracking-tight">Suggestion</h3>
                      <button hlmBtn variant="ghost" size="sm"
                        class="h-6 gap-1 px-2 text-[10px] font-bold tracking-wider text-primary hover:text-primary/80 hover:bg-primary/10 rounded-md transition-colors"
                        (click)="openTool(tool.name)">
                        OPEN <ng-icon hlm name="lucideExternalLink" class="size-3" />
                      </button>
                    </div>

                    <!-- Content Item -->
                    <div class="p-4 flex gap-3 bg-popover hover:bg-muted/10 transition-colors group/item">
                      <!-- Avatar -->
                      <div class="shrink-0">
                        <div
                          class="size-10 rounded-lg bg-muted/50 border border-border flex items-center justify-center overflow-hidden">
                          <img [src]="getToolLogo(tool.name)" [alt]="tool.name"
                            class="size-6 object-contain opacity-90 group-hover/item:scale-110 transition-transform duration-300">
                        </div>
                      </div>

                      <!-- Text Content -->
                      <div class="flex-1 space-y-1 min-w-0">
                        <div class="flex items-start justify-between gap-2">
                          <p class="text-sm font-semibold text-popover-foreground leading-none truncate pr-1">
                            {{ tool.name }} <span class="font-normal text-muted-foreground">recommended</span>
                          </p>
                        </div>

                        <p class="text-xs text-muted-foreground font-medium">
                          via {{ tool.model }}
                        </p>

                        <p class="text-[11px] text-muted-foreground leading-relaxed pt-1.5 line-clamp-3">
                          "{{ tool.best_for }}"
                        </p>
                      </div>
                    </div>
                  </div>
                </ng-template>

                <div [hlmTooltipTrigger]="tooltipContent" #t="hlmTooltipTrigger" (click)="onToolClick($event, t)"
                  class="size-10 relative bg-card border border-border/20 rounded-lg flex items-center justify-center hover:bg-primary/10 hover:border-primary/40 hover:shadow-2xl hover:shadow-primary/10 transition-all duration-500 cursor-help active:scale-90 group/tool overflow-visible">
                  <!-- Glow pulse -->
                  <div
                    class="absolute inset-0 bg-primary/10 blur-xl opacity-0 group-hover/tool:opacity-100 transition-opacity duration-700 rounded-lg">
                  </div>

                  <img [src]="getToolLogo(tool.name)" [alt]="tool.name"
                    class="relative w-5 h-5 object-contain dark:brightness-0 dark:invert opacity-60 group-hover/tool:opacity-100 group-hover/tool:scale-125 transition-all duration-500 ease-out" />
                </div>
              </ng-container>

              <div *ngIf="analysis()?.suggestedTools?.length === 0"
                class="col-span-full p-4 border border-dashed border-border rounded-xl text-center">
                <p class="text-muted-foreground text-sm italic">No specific tools identified for this prompt.</p>
              </div>

              <div *ngIf="loading()" class="flex gap-4">
                <div *ngFor="let i of [1,2,3]" class="size-14 bg-muted/20 animate-pulse rounded-2xl"></div>
              </div>
            </div>
          </div>

          <!-- The Enhanced Result -->
          <div class="space-y-4 relative">
            <div class="flex items-center gap-2 px-1">
              <h3 class="text-sm font-bold uppercase tracking-[0.2em] text-primary"># Refined Strategy</h3>
            </div>

            <div class="relative group">
              <div
                class="absolute from-primary/30 to-blue-500/30 rounded-2xl opacity-10 group-hover:opacity-20 transition duration-500">
              </div>
              <div class="relative overflow-hidden rounded-2xl border border-primary/20 bg-card shadow-2xl">
                <div class="flex items-center justify-between px-6 py-3 border-b border-border/50 bg-muted/20">
                  <span class="text-[10px] uppercase tracking-widest font-bold text-muted-foreground">Optimal
                    Version</span>
                  <button *ngIf="analysis()" hlmBtn variant="ghost" size="sm"
                    class="h-8 gap-2 bg-background/50 hover:bg-primary hover:text-primary-foreground transition-all rounded-lg"
                    (click)="copyPrompt()">
                    <ng-icon hlm [name]="copied() ? 'lucideCheck' : 'lucideCopy'" class="size-3.5" />
                    <span class="text-[10px] font-bold">{{ copied() ? 'COPIED' : 'COPY' }}</span>
                  </button>
                </div>
                <div class="p-8">
                  <pre
                    class="w-full font-mono text-[13px] leading-[1.8] whitespace-pre-wrap text-foreground/90 selection:bg-primary/30">{{ analysis()?.enhancedPrompt || (loading() ? 'Forging the perfect response...' : '') }}</pre>
                </div>
              </div>
            </div>
          </div>

          <!-- Weakness Detection -->
          <div class="space-y-4">
            <div class="flex items-center gap-2 px-1">
              <h3 class="text-sm font-bold uppercase tracking-[0.2em] text-muted-foreground"># Weakness Analysis</h3>
            </div>

            <div class="grid grid-cols-1 gap-3">
              <div *ngFor="let problem of analysis()?.problems"
                class="p-2 bg-muted/40 border border-border/50 rounded-xl flex items-start gap-1 hover:border-yellow-500/30 transition-colors group">
                <span class="mt-0 size-4 ml-2 rounded-full transition-colors shrink-0"> # </span>
                <p class="text-sm pt-[2px] text-foreground/80 leading-relaxed">{{ problem }}</p>
              </div>
              <div *ngIf="loading()"
                class="p-4 bg-muted/20 border border-border/30 rounded-xl animate-pulse flex items-center gap-3">
                <div class="size-2 rounded-full bg-muted"></div>
                <div class="h-3 w-3/4 bg-muted/50 rounded"></div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>
  </div>
</main>

<router-outlet />